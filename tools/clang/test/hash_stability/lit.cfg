# -*- Python -*-

# Configuration file for the 'lit' test runner.

import os
import platform
import subprocess

import lit.formats
import lit.util

# name: The name of this test suite.
config.name = 'hash-stability'

llvm_tools_dir = getattr(config, 'llvm_tools_dir', None)
if not llvm_tools_dir:
	# Check for 'clang_hash_stability_site_config' user parameter, and use that if available.
	site_cfg = lit_config.params.get('clang_hash_stability_site_config', None)
	if site_cfg and os.path.exists(site_cfg):
		lit_config.load_config(config, site_cfg)
		raise SystemExit
	lit_config.fatal('No LLVM tools dir set!')

dxc_path = lit.util.which('dxc', llvm_tools_dir)
dxa_path = lit.util.which('dxa', llvm_tools_dir)
working_dir = config.working_dir

test_path = os.path.join(os.path.dirname(os.path.abspath(__file__)), '..')
tmp_path = os.path.join(working_dir, 'Output')

# create tmp_path if it doesn't exist
if not os.path.exists(tmp_path):
	try:
		os.makedirs(tmp_path)
	except OSError:
		print("Creation of the directory %s for temp output failed" % tmp_path)
		raise SystemExit
hash_stability_path = lit_config.params.get('hash_stability_path', None)
if hash_stability_path:
	test_path = hash_stability_path

config.test_format = lit.formats.DxcHashTest(test_path, dxc_path, dxa_path, working_dir)


# Test HashStability.py

# Don't use close_fds on Windows.
close_fds = platform.system() != 'Windows'

hs_path = os.path.join(os.path.dirname(os.path.realpath(__file__)),
             '..', '..', '..','..','utils',
             'hct', 'HashStability.py')

test_shader = os.path.join(os.path.dirname(os.path.realpath(__file__)),
             '..', 'DXC', 'Inputs','smoke.hlsl')

empty_env = os.environ.copy()
# clear PATH to make sure dxil.dll are not found.
empty_env["PATH"] = ""

args = ['python3', hs_path, '-a', f'dxc -T ps_6_0 {test_shader}', '-p', llvm_tools_dir]
proc = subprocess.Popen(args, cwd=working_dir,
                            env=empty_env,
                            # don't writ output to stdout
                            stdout=subprocess.PIPE,
                            stderr=subprocess.PIPE,
                            close_fds=close_fds)
stdout, stderr = proc.communicate()
res = proc.wait()
if res != 0:
    print(f"HashStability.py failed {args}, stdout:{stdout}, stderr:{stderr}")
    lit_config.fatal('HashStability.py test failed!')
